<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="icon.png" type="image/png">
    <meta name="theme-color" content="#f0f4f8">
    <title>Obƒçanka - Smart SRS v1.2</title>
    <style>
        :root {
            /* MODERN√ç MODR√â SCH√âMA (Obƒçanka) */
            --primary: #0056b3;    
            --accent: #d63384;     
            --accent-sec: #fd7e14; 
            --bg: #f0f4f8;         
            --card-front: #ffffff; 
            --text: #212529;
            --success: #198754;    
            --danger: #dc3545;
            --gray: #6c757d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg); margin: 0; 
            min-height: 100vh; color: var(--text);
            overflow-y: auto; 
        }

        body.learning-active { height: 100vh; overflow: hidden; }

        .container { 
            width: 100%; max-width: 600px; margin: 0 auto;
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* --- MENU --- */
        #ui-menu, #ui-editor { padding: 20px; flex: 1; }

        h2 { color: var(--primary); font-weight: 800; letter-spacing: -0.5px; text-align: center; margin-bottom: 5px; }

        /* GAMIFIKACE */
        .stats-dashboard {
            background: white; padding: 20px; border-radius: 20px; 
            margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0, 86, 179, 0.08); border: none;
        }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .stat-val { font-size: 1.6rem; font-weight: 900; color: var(--primary); }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--gray); font-weight: bold; margin-top: 5px; letter-spacing: 1px; }
        .stat-streak-color { color: var(--accent-sec); }

        .brain-bar { height: 12px; background: #e9ecef; border-radius: 6px; display: flex; overflow: hidden; width: 100%; }
        .bb-part { height: 100%; transition: width 0.5s; }
        .bb-master { background: var(--success); }
        .bb-learn { background: var(--primary); opacity: 0.6; }
        .bb-new { background: #e9ecef; }
        .brain-legend { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--gray); margin-top: 8px; font-weight: 500; }

        /* DECK MENU */
        .deck-menu { padding: 0; margin-bottom: 25px; }
        .deck-option { 
            display: flex; align-items: center; background: white; padding: 15px; margin-bottom: 12px; 
            border-radius: 16px; border: 1px solid transparent; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); transition: transform 0.2s; 
        }
        .deck-option:active { transform: scale(0.98); }
        .deck-option input { width: 22px; height: 22px; margin-right: 15px; accent-color: var(--primary); cursor: pointer; }
        .deck-info { flex-grow: 1; cursor: pointer; }
        .deck-name { font-weight: 700; font-size: 1.1rem; display: block; color: var(--primary); margin-bottom: 3px; }
        .deck-sub { font-size: 0.8rem; color: var(--gray); }

        /* TLAƒå√çTKA */
        .btn-main { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; width: 100%; font-weight: 700; font-size: 1.1rem; margin-top: 10px; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 86, 179, 0.2); transition: 0.2s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 86, 179, 0.3); }
        .btn-alt { background: white; color: var(--primary); border: 2px solid var(--primary); padding: 12px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px; }
        
        .admin-panel { background: white; border: 1px solid #e9ecef; padding: 20px; border-radius: 20px; margin-bottom: 30px; }
        .btn-utility { background: #e9ecef; color: var(--text); border: none; padding: 12px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-reset { color: var(--danger); background: none; border: none; font-size: 0.8rem; font-weight: 600; margin-top: 20px; cursor: pointer; opacity: 0.7; display: block; margin: 20px auto 0; }

        /* UƒåEN√ç - FIXN√ç V√ù≈†KA 380px */
        #ui-learning { display: flex; flex-direction: column; height: 100%; padding: 20px; overflow-y: auto; background: white; }
        .stats-bar { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 15px; font-size: 0.9rem; color: var(--gray); }
        .progress-container { width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; margin-bottom: 25px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .card-area { width: 100%; display: flex; justify-content: center; }
        /* FIXN√ç V√ù≈†KA JAKO V DƒöJEPISU */
        .card-box { width: 100%; height: 380px; position: relative; cursor: pointer; perspective: 1000px; }
        
        .card { width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; position: relative; }
        .card.flipped { transform: rotateY(180deg); }
        
        .card-front, .card-back { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 24px; padding: 30px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid #f0f0f0;
            overflow-y: auto; /* Obsah se scrolluje uvnit≈ô karty */
        }
        .card-front { background: white; color: var(--text); }
        .card-back { background: var(--primary); color: white; transform: rotateY(180deg); align-items: flex-start; text-align: left; }

        .q-text { font-size: 1.6rem; font-weight: 800; line-height: 1.4; color: var(--primary); }
        .a-list { padding-left: 20px; font-size: 1.25rem; list-style: none; margin: 0; width: 100%; }
        .a-list li { margin-bottom: 12px; position: relative; padding-left: 10px; }
        .a-list li::before { content: "‚Ä¢"; color: var(--accent-sec); font-weight: bold; position: absolute; left: -15px; }

        /* SRS TLAƒå√çTKA */
        .controls-wrapper { margin-top: 20px; }
        #ui-btns-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .srs-btn { border: none; padding: 15px 5px; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 0.9rem; }
        .srs-btn span { font-size: 0.7rem; font-weight: 400; margin-top: 4px; opacity: 0.8; }
        .b-0 { background: var(--danger); } 
        .b-1 { background: #fd7e14; } 
        .b-2 { background: #0dcaf0; color: #000; } 
        .b-3 { background: var(--success); }

        /* EDITOR STYLY */
        input[type="text"], textarea { border: 2px solid #e9ecef; background: #f8f9fa; border-radius: 12px; padding: 15px; width: 100%; font-family: inherit; transition: 0.2s; margin-top: 5px;}
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); outline: none; background: white; }
        .input-label { font-size:0.8rem; font-weight:bold; color:var(--gray); display: block; margin-top: 15px; }

        /* LOADER (Pro import) */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:999; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:bold; color:var(--primary);">Pracuji...</p></div>

<div class="container">
    <div id="ui-menu">
        <h2>üèõÔ∏è Obƒçanka <span style="font-weight:300; color:var(--text);">Smart SRS</span></h2>
        <p style="text-align:center; color:var(--gray); font-size:0.9rem; margin-bottom:25px;">V√Ωchova k obƒçanstv√≠ pro Z≈†</p>
        
        <div class="stats-dashboard">
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-val stat-streak-color" id="stat-streak">0</span><span class="stat-label">Dn√≠ v ≈ôadƒõ</span></div>
                <div class="stat-item"><span class="stat-val" id="stat-xp">0</span><span class="stat-label">Kartiƒçek</span></div>
                <div class="stat-item"><span class="stat-val" id="stat-mastered">0%</span><span class="stat-label">Um√≠m</span></div>
            </div>
            <div class="brain-bar"><div id="bb-master" class="bb-part bb-master" style="width:0%"></div><div id="bb-learn" class="bb-part bb-learn" style="width:0%"></div><div id="bb-new" class="bb-part bb-new" style="width:100%"></div></div>
            <div class="brain-legend"><span>Um√≠m (14d+)</span><span>Tr√©nuji</span><span>Nov√©</span></div>
        </div>

        <div class="deck-menu">
            <h4 style="margin:0 0 15px 5px; color:var(--gray); text-transform:uppercase; font-size:0.8rem; letter-spacing:1px;">T√©mata k procviƒçen√≠</h4>
            <div id="deck-list">Naƒç√≠t√°m...</div>
            <button class="btn-main" onclick="startSession()">Start üöÄ</button>
            <button class="btn-alt" onclick="openCreator()">Vytvo≈ôit t√©ma</button>
        </div>

        <div class="admin-panel">
            <h4 style="margin:0 0 15px 0; color:var(--gray); font-size:0.9rem;">SPR√ÅVA APLIKACE</h4>
            <div style="display: flex; gap: 10px;">
                <button class="btn-utility" onclick="exportData()">üíæ Z√°loha</button>
                <button class="btn-utility" onclick="document.getElementById('file-in').click()">üìÇ Nahr√°t</button>
            </div>
            <input type="file" id="file-in" accept=".json,application/json" class="hidden" onchange="importData(event)">
            <button class="btn-reset" onclick="fullReset()">Smazat v≈°echna data (Reset)</button>
        </div>
        
        <div style="text-align:center; color:#adb5bd; font-size:0.7rem; margin-top:20px;">Verze 1.2 (OV)</div>
    </div>

    <div id="ui-learning" class="hidden">
        <div class="stats-bar"><span id="progress-text">1 / 10</span><span onclick="closeLearning()" style="cursor:pointer; color:var(--primary);">Menu</span></div>
        <div class="progress-container"><div id="progress-fill" class="progress-fill"></div></div>
        <div class="card-area"><div class="card-box" onclick="handleFlip()"><div class="card" id="card-el"><div class="card-front" id="f-content"></div><div class="card-back" id="b-content"></div></div></div></div>
        <div class="controls-wrapper">
            <div id="ui-btns-container" class="hidden">
                <button class="srs-btn b-0" onclick="handleSRS(0)">Znovu<span>&lt;1m</span></button>
                <button class="srs-btn b-1" onclick="handleSRS(3)">Tƒõ≈æk√©<span>10m</span></button>
                <button class="srs-btn b-2" onclick="handleSRS(4)">Dobr√©<span>1d</span></button>
                <button class="srs-btn b-3" onclick="handleSRS(5)">Snadn√©<span>4d</span></button>
            </div>
            <div id="flip-hint" style="text-align:center; color:var(--gray); margin-top:15px; font-size:0.9rem;">Klikni pro otoƒçen√≠</div>
        </div>
    </div>

    <div id="ui-editor" class="hidden" style="background:white;">
        <h3 id="editor-title" style="margin-top:0; color:var(--primary);">Editor</h3>
        <span class="input-label">N√ÅZEV T√âMATU</span>
        <input type="text" id="in-deck-name" placeholder="Nap≈ô. Volby">
        <div id="card-form" class="hidden" style="margin-top:20px;">
            <div style="background:#f8f9fa; padding:15px; border-radius:15px; margin-bottom:15px;">
                <span class="input-label" style="margin-top:0;">OT√ÅZKA</span>
                <input type="text" id="in-card-q" placeholder="Znƒõn√≠ ot√°zky...">
                <span class="input-label">ODPOVƒöƒé (≈ô√°dky)</span>
                <textarea id="in-card-a" rows="3" placeholder="Odpovƒõƒè..."></textarea>
                <button class="btn-main" onclick="saveCard()" style="padding:12px; font-size:1rem; margin-top:15px;">Ulo≈æit kartu</button>
            </div>
            <div id="editor-card-list"></div>
        </div>
        <button class="btn-main" id="btn-next" onclick="confirmName()">Pokraƒçovat</button>
        <button class="btn-alt" style="margin-top:15px; border:none; color:var(--gray);" onclick="location.reload()">Zpƒõt</button>
    </div>
</div>

<script>
    const APP_VERSION_DISPLAY = "v1.2 (OV)";
    const DB_NAME = "CivicsSRSDatabase";
    const DB_VERSION = 1;
    let db, decks = {}, sessionCards = [], sessionIdx = 0;

    // --- POƒå√ÅTEƒåN√ç OBSAH (Obƒçanka) ---
    const INITIAL_CONTENT = {
        "Rodina a ≈°kola": [
            { q: "Jak√Ω je hlavn√≠ √∫kol rodiny?", a: ["V√Ωchova dƒõt√≠", "P√©ƒçe o ƒçleny rodiny", "Citov√© z√°zem√≠"], id: 101, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Co je to ne√∫pln√° rodina?", a: ["Rodina, kde chyb√≠ jeden z rodiƒç≈Ø (nejƒçastƒõji po rozvodu nebo √∫mrt√≠)."], id: 102, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Jak√© jsou z√°kladn√≠ pot≈ôeby d√≠tƒõte?", a: ["Biologick√© (j√≠dlo, sp√°nek)", "Psychick√© (l√°ska, bezpeƒç√≠)", "Soci√°ln√≠ (vzdƒõl√°n√≠, kamar√°di)"], id: 103, reps:0, interval:0, ef:2.5, nextReview: Date.now() }
        ],
        "Obec a samospr√°va": [
            { q: "Kdo stoj√≠ v ƒçele obce?", a: ["Starosta (nebo prim√°tor ve mƒõstech)."], id: 201, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Kdo vol√≠ starostu?", a: ["Zastupitelstvo obce (nikoliv p≈ô√≠mo obƒçan√©)."], id: 202, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Co je to obecn√≠ zastupitelstvo?", a: ["Sbor zvolen√Ωch z√°stupc≈Ø obƒçan≈Ø, kte≈ô√≠ rozhoduj√≠ o chodu obce."], id: 203, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Jak se naz√Ωv√° √∫≈ôad, kter√Ω spravuje obec?", a: ["Obecn√≠ √∫≈ôad (nebo Mƒõstsk√Ω √∫≈ôad / Magistr√°t)."], id: 204, reps:0, interval:0, ef:2.5, nextReview: Date.now() }
        ],
        "St√°tn√≠ symboly ƒåR": [
            { q: "Vyjmenuj v≈°ech 7 st√°tn√≠ch symbol≈Ø ƒåR.", a: ["Velk√Ω st√°tn√≠ znak", "Mal√Ω st√°tn√≠ znak", "St√°tn√≠ vlajka", "Vlajka prezidenta republiky", "St√°tn√≠ peƒçe≈•", "St√°tn√≠ barvy (trikol√≥ra)", "St√°tn√≠ hymna"], id: 301, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Jak se jmenuje st√°tn√≠ hymna ƒåR a kdo ji slo≈æil?", a: ["Kde domov m≈Øj", "Hudba: Franti≈°ek ≈†kroup", "Slova: Josef Kajet√°n Tyl"], id: 302, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Kdy pou≈æ√≠v√°me Mal√Ω st√°tn√≠ znak?", a: ["P≈ôi men≈°√≠ch √∫≈ôedn√≠ch √∫konech (nap≈ô. raz√≠tka ≈°kol, √∫≈ôad≈Ø)."], id: 303, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Jak√© zv√≠≈ôe dominuje Velk√©mu st√°tn√≠mu znaku?", a: ["St≈ô√≠brn√Ω dvouocas√Ω lev (ƒåechy)."], id: 304, reps:0, interval:0, ef:2.5, nextReview: Date.now() }
        ],
        "St√°tn√≠ sv√°tky": [
            { q: "Co slav√≠me 28. ≈ô√≠jna?", a: ["Den vzniku samostatn√©ho ƒçeskoslovensk√©ho st√°tu (1918)."], id: 401, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Co slav√≠me 17. listopadu?", a: ["Den boje za svobodu a demokracii (1939 a 1989)."], id: 402, reps:0, interval:0, ef:2.5, nextReview: Date.now() },
            { q: "Kdy slav√≠me Den v√≠tƒõzstv√≠ (konec 2. sv. v√°lky)?", a: ["8. kvƒõtna."], id: 403, reps:0, interval:0, ef:2.5, nextReview: Date.now() }
        ]
    };

    // --- DB & INIT ---
    async function init() {
        await new Promise(r => { const req = indexedDB.open(DB_NAME, DB_VERSION); req.onupgradeneeded = e => e.target.result.createObjectStore("state"); req.onsuccess = e => { db = e.target.result; r(); } });
        
        // 1. Zkontrolovat QR import
        await checkUrlForImport();

        // 2. Naƒç√≠st data
        const saved = await new Promise(r => { const tx = db.transaction("state", "readonly").objectStore("state").get("decks"); tx.onsuccess = () => r(tx.result); });
        decks = saved || INITIAL_CONTENT;
        if(!saved) saveDb();
        
        renderMenu();
    }
    function saveDb() { db.transaction("state", "readwrite").objectStore("state").put(decks, "decks"); }

    // --- MAGICK√ù IMPORT (QR) ---
    async function checkUrlForImport() {
        const urlParams = new URLSearchParams(window.location.search);
        const deckFile = urlParams.get('balicek'); // ?balicek=nazev.json
        if (deckFile) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(deckFile);
                if(!res.ok) throw new Error("Soubor nedostupn√Ω");
                const newData = await res.json();
                
                // Naƒçteme aktu√°ln√≠ data pro slouƒçen√≠
                const current = await new Promise(r => { const tx = db.transaction("state", "readonly").objectStore("state").get("decks"); tx.onsuccess = () => r(tx.result); }) || INITIAL_CONTENT;
                
                // Slouƒçen√≠ (Smart Merge)
                const merged = smartMerge(current, newData);
                
                // Ulo≈æit
                decks = merged; 
                saveDb();
                
                // Vyƒçistit URL
                window.history.replaceState({}, document.title, window.location.pathname);
                alert(`Bal√≠ƒçek nahr√°n!`);
            } catch(e) { alert("Chyba importu: " + e.message); } finally { document.getElementById('loader').style.display = 'none'; }
        }
    }

    function smartMerge(oldDecks, newDecksImport) {
        let incoming = Array.isArray(newDecksImport) ? {"Nov√Ω bal√≠ƒçek": newDecksImport} : newDecksImport;
        for (const [name, cards] of Object.entries(incoming)) {
            if (!oldDecks[name]) oldDecks[name] = [];
            cards.forEach(c => {
                const existIdx = oldDecks[name].findIndex(ex => ex.id === c.id);
                if (existIdx !== -1) {
                    const old = oldDecks[name][existIdx];
                    oldDecks[name][existIdx] = {...c, reps: old.reps||0, interval: old.interval||0, ef: old.ef||2.5, nextReview: old.nextReview||Date.now()};
                } else {
                    oldDecks[name].push({...c, reps:0, interval:0, ef:2.5, nextReview: Date.now()});
                }
            });
        }
        return oldDecks;
    }

    // --- GUI & LOGIKA ---
    function renderMenu() {
        // Stats
        let s = JSON.parse(localStorage.getItem('civics_stats')) || {streak:0, last:"", total:0};
        document.getElementById('stat-streak').innerText = s.streak;
        document.getElementById('stat-xp').innerText = s.total;
        
        let cN=0, cL=0, cM=0;
        Object.values(decks).forEach(d => d.forEach(c => { if(c.reps===0) cN++; else if(c.interval>=14) cM++; else cL++; }));
        const t = cN+cL+cM || 1;
        document.getElementById('bb-master').style.width = (cM/t*100)+"%";
        document.getElementById('bb-learn').style.width = (cL/t*100)+"%";
        document.getElementById('bb-new').style.width = (cN/t*100)+"%";
        document.getElementById('stat-mastered').innerText = Math.round(cM/t*100)+"%";

        // Deck List
        const list = document.getElementById('deck-list'); list.innerHTML = "";
        Object.keys(decks).forEach(n => {
            const due = decks[n].filter(c => c.nextReview <= Date.now()).length;
            list.innerHTML += `<div class="deck-option"><input type="checkbox" value="${n}" checked><div class="deck-info" onclick="openEditor('${n}')"><span class="deck-name">${n}</span><span class="deck-sub">${decks[n].length} karet ‚Ä¢ ${due} k opakov√°n√≠</span></div></div>`;
        });
    }

    function startSession() {
        const sel = Array.from(document.querySelectorAll('#deck-list input:checked')).map(i => i.value);
        if(!sel.length) return;
        let all = []; sel.forEach(n => all = all.concat(decks[n]));
        let due = all.filter(c => c.nextReview <= Date.now()).sort((a,b)=>a.nextReview-b.nextReview).slice(0, 20);
        if(!due.length) { alert("V≈°e um√≠≈°! Zkus to z√≠tra."); return; }
        sessionCards = due; sessionIdx = 0;
        document.getElementById('ui-menu').classList.add('hidden');
        document.getElementById('ui-learning').classList.remove('hidden');
        renderCard();
    }

    function renderCard() {
        if(sessionIdx >= sessionCards.length) { location.reload(); return; }
        const c = sessionCards[sessionIdx];
        document.getElementById('progress-text').innerText = `${sessionIdx+1} / ${sessionCards.length}`;
        document.getElementById('progress-fill').style.width = ((sessionIdx/sessionCards.length)*100)+"%";
        
        // Render Front
        let qContent = `<div class="q-text">${c.q}</div>`;
        if(c.qImg) qContent += `<img src="${c.qImg}" style="max-height:150px; margin-top:10px; border-radius:8px;">`;
        document.getElementById('f-content').innerHTML = qContent;
        
        document.getElementById('b-content').innerHTML = "";
        document.getElementById('card-el').classList.remove('flipped');
        document.getElementById('ui-btns-container').classList.add('hidden');
        document.getElementById('flip-hint').classList.remove('hidden');
    }

    function handleFlip() {
        const c = sessionCards[sessionIdx];
        if(document.getElementById('card-el').classList.contains('flipped')) return;
        document.getElementById('card-el').classList.add('flipped');
        
        setTimeout(() => {
            let html = c.a.length > 1 ? `<ul class="a-list">${c.a.map(x=>`<li>${x}</li>`).join('')}</ul>` : `<div style="font-size:1.4rem; font-weight:bold;">${c.a[0]}</div>`;
            if(c.aImg) html += `<img src="${c.aImg}" style="max-height:150px; margin-top:10px; border-radius:8px;">`;
            document.getElementById('b-content').innerHTML = html;
            document.getElementById('ui-btns-container').classList.remove('hidden');
            document.getElementById('flip-hint').classList.add('hidden');
        }, 300);
    }

    function handleSRS(q) {
        let c = sessionCards[sessionIdx];
        
        // Stats
        let s = JSON.parse(localStorage.getItem('civics_stats')) || {streak:0, last:"", total:0};
        const today = new Date().toISOString().split('T')[0];
        if(s.last !== today) { s.streak = (s.last === new Date(Date.now()-86400000).toISOString().split('T')[0]) ? s.streak+1 : 1; s.last = today; }
        s.total++; localStorage.setItem('civics_stats', JSON.stringify(s));

        // Logic
        c.reps = c.reps||0; c.interval = c.interval||0; c.ef = c.ef||2.5;
        if(q<3) { c.reps=0; c.interval=0; c.nextReview=Date.now(); sessionCards.push(c); }
        else {
            c.interval = (c.reps===0) ? (q===3?0.007 : (q===4?1:4)) : Math.round(c.interval * c.ef);
            c.reps++; c.ef = Math.max(1.3, c.ef+(0.1-(5-q)*(0.08+(5-q)*0.02)));
            c.nextReview = Date.now() + c.interval*86400000;
        }
        
        // Update in DB
        for(let n in decks) { const i = decks[n].findIndex(x=>x.id===c.id); if(i!==-1) { decks[n][i]=c; break; } }
        saveDb(); sessionIdx++; renderCard();
    }

    function closeLearning() { location.reload(); }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(decks)])); a.download="obcanka_srs.json"; a.click(); }
    function importData(e) { 
        const r = new FileReader();
        r.onload = async (v) => {
            try {
                const newData = JSON.parse(v.target.result);
                const current = await new Promise(res => { const tx = db.transaction("state", "readonly").objectStore("state").get("decks"); tx.onsuccess = () => res(tx.result); }) || INITIAL_CONTENT;
                decks = smartMerge(current, newData);
                saveDb(); alert("Nahr√°no!"); location.reload();
            } catch(err) { alert("Chyba."); }
        };
        r.readAsText(e.target.files[0]);
    }
    
    function fullReset() { 
        if(confirm("OPRAVDU SMAZAT V≈†ECHNA DATA?")) { 
            indexedDB.deleteDatabase(DB_NAME); 
            localStorage.removeItem('civics_stats'); 
            location.reload(); 
        } 
    }

    // Editor (Zjednodu≈°en√Ω pro mobil)
    let activeDeck = "";
    window.openEditor = function(n) { activeDeck = n; document.getElementById('ui-menu').classList.add('hidden'); document.getElementById('ui-editor').classList.remove('hidden'); document.getElementById('in-deck-name').value = n; confirmName(); }
    window.openCreator = function() { activeDeck = ""; document.getElementById('ui-menu').classList.add('hidden'); document.getElementById('ui-editor').classList.remove('hidden'); document.getElementById('in-deck-name').value = ""; document.getElementById('card-form').classList.add('hidden'); document.getElementById('btn-next').classList.remove('hidden'); }
    window.confirmName = function() { const n = document.getElementById('in-deck-name').value; if(!n) return; if(!decks[n]) decks[n]=[]; activeDeck=n; document.getElementById('btn-next').classList.add('hidden'); document.getElementById('card-form').classList.remove('hidden'); renderEdList(); }
    window.saveCard = function() { const q=document.getElementById('in-card-q').value, a=document.getElementById('in-card-a').value; if(!q||!a)return; decks[activeDeck].push({q, a:a.split('\n'), id:Date.now(), reps:0, interval:0, ef:2.5, nextReview:Date.now()}); saveDb(); renderEdList(); document.getElementById('in-card-q').value=""; document.getElementById('in-card-a').value=""; }
    function renderEdList() { document.getElementById('editor-card-list').innerHTML = decks[activeDeck].map(c=>`<div style="padding:10px; border-bottom:1px solid #eee; font-size:0.9rem;">${c.q}</div>`).join(''); }

    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    init();
</script>
</body>
</html>